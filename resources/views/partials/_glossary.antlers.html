<div class="w-full" id="glossary-container">
  
  <!-- Search Filter -->
  <div class="mb-6 max-w-md">
    <div class="relative">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="h-5 w-5 text-amp-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
      <input 
        id="search-input"
        type="text" 
        placeholder="Filter events by name..." 
        class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
      >
      <div id="clear-btn" class="absolute inset-y-0 right-0 pr-3 flex items-center" style="display: none;">
        <button class="text-amp-gray-400 hover:text-amp-gray-500">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Column Headers -->
  <div class="hidden lg:block">
    <div class="grid grid-cols-3-columns gap-6 p-4 bg-gray-50 border-b border-gray-200 font-medium text-sm text-amp-gray-700">
      <div>Event Name</div>
      <div>Properties</div>
      <div>Description</div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading" class="flex items-center justify-center py-12">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
    <span class="ml-2 text-amp-gray-600">Loading glossary...</span>
  </div>

  <!-- Content will be populated by JavaScript -->
  <div id="glossary-content" class="divide-y divide-gray-200" style="display: none;"></div>
  
  <!-- Error State -->
  <div id="error" class="text-center py-12 text-red-600" style="display: none;">
    <p>Failed to load glossary data. Please try again.</p>
  </div>
</div>

<style>
.grid-cols-3-columns {
  grid-template-columns: 250px 200px 1fr;
}

@media (max-width: 1024px) {
  .grid-cols-3-columns { 
    grid-template-columns: 200px 180px 1fr; 
    gap: 1rem; 
  }
  .grid-cols-300-1fr { grid-template-columns: 250px 1fr; gap: 0.75rem; }
  .grid-cols-200-1fr-120 { grid-template-columns: 150px 1fr 100px; gap: 0.5rem; }
}

@media (max-width: 768px) {
  .grid-cols-3-columns { 
    grid-template-columns: 1fr; 
    gap: 0.5rem; 
  }
  .grid-cols-300-1fr { grid-template-columns: 1fr; gap: 0.5rem; }
  .grid-cols-200-1fr-120 { grid-template-columns: 1fr; gap: 0.25rem; }
}

@media (max-width: 768px) {
  .mobile-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
  }
}

@media (min-width: 769px) {
  .mobile-label {
    display: none;
  }
}
</style>

<script>
class GlossaryRenderer {
  constructor() {
    this.data = null;
    this.filteredEvents = [];
    this.openProperties = new Set();
    this.init();
  }

  async init() {
    try {
      await this.loadData();
      this.render();
      this.setupSearch();
      this.hideLoading();
    } catch (error) {
      console.error('Failed to load glossary:', error);
      this.showError();
    }
  }

  async loadData() {
    const response = await fetch('/glossary-data.json');
    if (!response.ok) throw new Error('Failed to fetch data');
    this.data = await response.json();
    this.filteredEvents = this.data.events;
  }

  render() {
    const content = document.getElementById('glossary-content');
    content.innerHTML = this.filteredEvents.map(event => this.renderEvent(event)).join('');
  }

  renderEvent(event) {
    const platformBadges = event.platform.map(platform => {
      const colors = {
        web: 'bg-green-100 text-green-800',
        ios: 'bg-gray-100 text-amp-gray-800', 
        android: 'bg-emerald-100 text-emerald-800'
      };
      const icons = { web: 'üåê', ios: 'üì±', android: 'ü§ñ' };
      
      return `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ${colors[platform] || 'bg-blue-100 text-blue-800'}">
        ${icons[platform] || '‚≠ê'}
      </span>`;
    }).join('');

    const propertiesButton = event.related_properties_count > 0 ? `
      <button 
        onclick="glossary.toggleProperties('${event.id}')"
        id="btn-${event.id}"
        class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-amp-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors"
      >
        <span id="btn-text-${event.id}">‚ñ∂ Show Properties (${event.related_properties_count})</span>
      </button>
    ` : '<div class="text-sm text-amp-gray-500 italic">No properties</div>';

    const expandedProperties = event.related_properties_count > 0 ? `
      <div id="props-${event.id}" style="display: none;" class="bg-gray-50 rounded-md p-4 border border-gray-200 mt-3">
        ${this.renderProperties(event.related_properties)}
      </div>
    ` : '';

    return `
      <div class="event-row p-4 hover:bg-gray-50 transition-colors duration-150" data-event-title="${event.title}">
        <!-- Main 3-column layout -->
        <div class="grid grid-cols-3-columns gap-6">
          <!-- Event Name Column -->
          <div class="flex flex-col justify-start">
            <div class="mobile-label">Event Name</div>
            <h3 class="text-sm font-medium text-amp-gray-900 mb-2">${event.title}</h3>
            <div class="flex flex-wrap gap-1">${platformBadges}</div>
          </div>
          
          <!-- Properties Column -->
          <div class="flex flex-col justify-start mt-4 lg:mt-0">
            <div class="mobile-label">Properties</div>
            ${propertiesButton}
          </div>
          
          <!-- Description Column -->
          <div class="flex flex-col justify-start mt-4 lg:mt-0">
            <div class="mobile-label">Description</div>
            <div class="text-sm text-amp-gray-700 leading-relaxed">${event.description}</div>
          </div>
        </div>
        
        <!-- Expanded Properties (full width, outside the grid) -->
        ${expandedProperties}
      </div>
    `;
  }

  renderProperties(properties) {
    return `
      <div class="divide-y divide-gray-200">
        ${properties.map(prop => `
          <div class="grid grid-cols-2 gap-4 py-3 hover:bg-white transition-colors">
            <div class="text-sm font-medium text-amp-gray-900">${prop.title}</div>
            <div>
              ${prop.data_type && prop.data_type.length > 0 ? `
                <div class="flex flex-wrap gap-1 mb-2">
                  ${prop.data_type.map(type => 
                    `<span class="inline-block px-2 py-0.5 text-xs bg-gray-100 text-amp-gray-800 rounded">${type}</span>`
                  ).join('')}
                </div>
              ` : ''}
              <div class="text-sm text-amp-gray-700 leading-relaxed">${prop.description}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  toggleProperties(eventId) {
    const props = document.getElementById(`props-${eventId}`);
    const btn = document.getElementById(`btn-text-${eventId}`);
    const isHidden = props.style.display === 'none';
    
    props.style.display = isHidden ? 'block' : 'none';
    
    const event = this.data.events.find(e => e.id === eventId);
    btn.textContent = isHidden 
      ? '‚ñº Hide Properties' 
      : `‚ñ∂ Show Properties (${event.related_properties_count})`;
  }

  setupSearch() {
    const input = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-btn');
    
    input.addEventListener('input', (e) => {
      const value = e.target.value.toLowerCase();
      clearBtn.style.display = value ? 'flex' : 'none';
      
      this.filteredEvents = this.data.events.filter(event =>
        event.title.toLowerCase().includes(value)
      );
      
      this.render();
    });
    
    clearBtn.addEventListener('click', () => {
      input.value = '';
      clearBtn.style.display = 'none';
      this.filteredEvents = this.data.events;
      this.render();
    });
  }

  hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('glossary-content').style.display = 'block';
  }

  showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  window.glossary = new GlossaryRenderer();
});
</script>