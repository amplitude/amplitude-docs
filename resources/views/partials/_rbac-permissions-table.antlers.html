<div id="rbac-permissions-container">
  <div class="mb-6">
    <div class="flex flex-col sm:flex-row gap-4 mb-4">
      <div class="flex-1">
        <input 
          type="text" 
          id="rbac-search" 
          placeholder="Search permissions..." 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>
      <div class="flex gap-2">
        <select id="product-area-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="">All Product Areas</option>
        </select>
        <select id="advanced-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="">All Permissions</option>
          <option value="true">Advanced Only</option>
          <option value="false">Basic Only</option>
        </select>
      </div>
    </div>
    
    <div class="flex justify-between items-center text-sm text-gray-600 mb-4">
      <span id="results-count">Loading permissions...</span>
      <button id="clear-filters" class="text-blue-600 hover:text-blue-800 underline">Clear Filters</button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Permission
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Product Area
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Type
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Description
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="permissions-table-body" class="bg-white divide-y divide-gray-200">
        <!-- Permissions will be populated here -->
      </tbody>
    </table>
  </div>

  <div id="no-results" class="text-center py-8 text-gray-500 hidden">
    <p>No permissions found matching your search criteria.</p>
  </div>
</div>

<script>
class RBACPermissionsTable {
  constructor() {
    this.permissions = [];
    this.filteredPermissions = [];
    this.currentFilters = {
      search: '',
      productArea: '',
      advanced: ''
    };
    
    this.init();
  }

  async init() {
    await this.loadPermissions();
    this.setupEventListeners();
    this.populateFilters();
    this.renderTable();
  }

  async loadPermissions() {
    try {
      const response = await fetch('/docs/rbac-permissions-data.json');
      const data = await response.json();
      this.permissions = data.permissions;
      this.filteredPermissions = [...this.permissions];
    } catch (error) {
      console.error('Failed to load RBAC permissions:', error);
      document.getElementById('results-count').textContent = 'Failed to load permissions';
    }
  }

  setupEventListeners() {
    const searchInput = document.getElementById('rbac-search');
    const productAreaFilter = document.getElementById('product-area-filter');
    const advancedFilter = document.getElementById('advanced-filter');
    const clearFiltersBtn = document.getElementById('clear-filters');

    searchInput.addEventListener('input', (e) => {
      this.currentFilters.search = e.target.value.toLowerCase();
      this.applyFilters();
    });

    productAreaFilter.addEventListener('change', (e) => {
      this.currentFilters.productArea = e.target.value;
      this.applyFilters();
    });

    advancedFilter.addEventListener('change', (e) => {
      this.currentFilters.advanced = e.target.value;
      this.applyFilters();
    });

    clearFiltersBtn.addEventListener('click', () => {
      this.clearFilters();
    });
  }

  populateFilters() {
    const productAreas = [...new Set(this.permissions.map(p => p.product_area).filter(Boolean))].sort();
    const productAreaSelect = document.getElementById('product-area-filter');
    
    productAreas.forEach(area => {
      const option = document.createElement('option');
      option.value = area;
      option.textContent = this.formatProductArea(area);
      productAreaSelect.appendChild(option);
    });
  }

  formatProductArea(area) {
    const areaMap = {
      'charts-metrics': 'Charts & Metrics',
      'experiment': 'Experiment',
      'data-management': 'Data Management',
      'audiences': 'Audiences',
      'integrations': 'Integrations',
      'session-replay': 'Session Replay',
      'heatmaps': 'Heatmaps',
      'guides-surveys': 'Guides & Surveys',
      'resource-center': 'Resource Center & Content',
      'admin': 'Admin'
    };
    return areaMap[area] || area;
  }

  applyFilters() {
    this.filteredPermissions = this.permissions.filter(permission => {
      const matchesSearch = !this.currentFilters.search || 
        permission.title.toLowerCase().includes(this.currentFilters.search) ||
        permission.description?.toLowerCase().includes(this.currentFilters.search) ||
        permission.actions?.some(action => action.toLowerCase().includes(this.currentFilters.search));

      const matchesProductArea = !this.currentFilters.productArea || 
        permission.product_area === this.currentFilters.productArea;

      const matchesAdvanced = !this.currentFilters.advanced || 
        permission.advanced.toString() === this.currentFilters.advanced;

      return matchesSearch && matchesProductArea && matchesAdvanced;
    });

    this.renderTable();
  }

  clearFilters() {
    this.currentFilters = { search: '', productArea: '', advanced: '' };
    document.getElementById('rbac-search').value = '';
    document.getElementById('product-area-filter').value = '';
    document.getElementById('advanced-filter').value = '';
    this.applyFilters();
  }

  renderTable() {
    const tbody = document.getElementById('permissions-table-body');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');

    // Update results count
    resultsCount.textContent = `Showing ${this.filteredPermissions.length} of ${this.permissions.length} permissions`;

    if (this.filteredPermissions.length === 0) {
      tbody.innerHTML = '';
      noResults.classList.remove('hidden');
      return;
    }

    noResults.classList.add('hidden');

    tbody.innerHTML = this.filteredPermissions.map(permission => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="font-medium text-gray-900">${this.escapeHtml(permission.title)}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            ${this.formatProductArea(permission.product_area)}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${permission.advanced ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'}">
            ${permission.advanced ? 'Advanced' : 'Basic'}
          </span>
        </td>
        <td class="px-6 py-4">
          <div class="text-sm text-gray-900">${this.escapeHtml(permission.description || '')}</div>
        </td>
        <td class="px-6 py-4">
          <div class="text-sm text-gray-600">
            ${permission.actions && permission.actions.length > 0 ? 
              permission.actions.map(action => `<div class="mb-1">â€¢ ${this.escapeHtml(action)}</div>`).join('') : 
              '<span class="text-gray-400">No specific actions</span>'
            }
          </div>
        </td>
      </tr>
    `).join('');
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// Initialize the table when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  new RBACPermissionsTable();
});
</script>
