{{# Try to get bundle data server-side first (works in dev, gets cached data in SSG build) #}}
{{ bundle_phobia :package="package_name" }}
{{ if _bundlephobia_success }}
    {{# Server-side data available - render immediately #}}
    <div class="rounded-lg border text-card-foreground bg-amp-gray-50 border-amp-gray-200 shadow-sm mb-8" data-bundle-loaded="true">
        <div class="p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="lucide lucide-package h-4 w-4 text-amp-gray-600">
                    <path d="m7.5 4.27 9 5.15"></path>
                    <path
                        d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z">
                    </path>
                    <path d="m3.3 7 8.7 5 8.7-5"></path>
                    <path d="M12 22V12"></path>
                </svg>
                <h3 class="font-medium text-amp-gray-900 text-sm m-0">
                    <a href="https://npmjs.com/package/{{package_name}}" target="_blank">Package Information</a>
                </h3>
            </div>
            <div class="space-y-2.5">
                <div>
                    <div class="text-xs text-amp-gray-500 mb-1">Package Name</div>
                    <code class="block font-mono text-xs bg-white px-2 py-1.5 rounded border border-amp-gray-200 text-amp-gray-700 w-full overflow-x-auto">{{name}}</code>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xs text-amp-gray-500 mb-1">Version</div>
                        <div class="font-medium text-amp-gray-900">{{version}}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-amp-gray-500 mb-1">Size (gzip)</div>
                        <div class="font-medium text-amp-gray-900">{{size_gzip_kb}} kB</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{{ else }}
    {{# Server-side data failed - use client-side loading as fallback #}}
    <div class="rounded-lg border text-card-foreground bg-amp-gray-50 border-amp-gray-200 shadow-sm mb-8" 
         data-bundle-package="{{package_name}}" 
         data-bundle-loader="true"
         data-is-static="{{ config:app:static-build }}">
        <div class="p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="lucide lucide-package h-4 w-4 text-amp-gray-600">
                    <path d="m7.5 4.27 9 5.15"></path>
                    <path
                        d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z">
                    </path>
                    <path d="m3.3 7 8.7 5 8.7-5"></path>
                    <path d="M12 22V12"></path>
                </svg>
                <h3 class="font-medium text-amp-gray-900 text-sm m-0">
                    <a href="https://npmjs.com/package/{{package_name}}" target="_blank">Package Information</a>
                </h3>
            </div>
            <div class="space-y-2.5">
                <div>
                    <div class="text-xs text-amp-gray-500 mb-1">Package Name</div>
                    <code class="block font-mono text-xs bg-white px-2 py-1.5 rounded border border-amp-gray-200 text-amp-gray-700 w-full overflow-x-auto">{{package_name}}</code>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xs text-amp-gray-500 mb-1">Version</div>
                        <div class="bundle-version">
                            <div class="animate-pulse bg-amp-gray-200 h-5 w-16 rounded"></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-amp-gray-500 mb-1">Size (gzip)</div>
                        <div class="bundle-size">
                            <div class="animate-pulse bg-amp-gray-200 h-5 w-12 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{{ /if }}
{{ /bundle_phobia }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bundleCards = document.querySelectorAll('[data-bundle-loader]');
    
    // Skip if no cards need loading (server-side data was successful)
    if (bundleCards.length === 0) return;
    
    bundleCards.forEach(async (card) => {
        const packageName = card.dataset.bundlePackage;
        const isStatic = card.dataset.isStatic === '1' || card.dataset.isStatic === 'true';
        
        try {
            let data;
            
            // Only try Laravel API if NOT in static build
            if (!isStatic) {
                try {
                    const response = await fetch(`/api/bundle-phobia?package=${encodeURIComponent(packageName)}`);
                    if (response.ok) {
                        data = await response.json();
                        if (data._bundlephobia_success) {
                            updateBundleSuccess(card, data);
                            return;
                        }
                    }
                } catch (apiError) {
                    console.warn('Laravel API not available, falling back to direct BundlePhobia API');
                }
            }
            
            // Direct BundlePhobia API (works in all environments)
            const response = await fetch(`https://bundlephobia.com/api/size?package=${encodeURIComponent(packageName)}`);
            
            if (response.ok) {
                const directData = await response.json();
                if (directData && directData.size) {
                    // Transform direct API response to match our format
                    const transformedData = {
                        name: directData.name || packageName,
                        version: directData.version || 'Latest',
                        size_gzip_kb: directData.gzip ? Math.round(directData.gzip / 1024 * 100) / 100 : 'N/A'
                    };
                    updateBundleSuccess(card, transformedData);
                    return;
                }
            }
            
            // Both APIs failed
            showBundleError(card, packageName, 'Unable to fetch bundle data');
            
        } catch (error) {
            console.warn('Bundle size fetch failed:', error);
            showBundleError(card, packageName, 'Network error');
        }
    });
    
    function updateBundleSuccess(card, data) {
        card.querySelector('.bundle-version').innerHTML = 
            `<div class="font-medium text-amp-gray-900">${data.version}</div>`;
        card.querySelector('.bundle-size').innerHTML = 
            `<div class="font-medium text-amp-gray-900">${data.size_gzip_kb} kB</div>`;
        
        // Mark as loaded
        card.removeAttribute('data-bundle-loader');
        card.setAttribute('data-bundle-loaded', 'true');
    }
    
    function showBundleError(card, packageName, errorMessage) {
        const flexContainer = card.querySelector('.flex.justify-between');
        flexContainer.innerHTML = `
            <div class="p-3 bg-white border border-amp-gray-200 rounded text-sm text-amp-gray-700 w-full">
                <p class="m-0 mb-2"><strong>Bundle size information temporarily unavailable.</strong></p>
                <p class="m-0 text-xs text-amp-gray-600">
                    Visit <a href="https://bundlephobia.com/package/${packageName}" target="_blank" class="text-amp-blue-600 underline">BundlePhobia</a> 
                    or <a href="https://npmjs.com/package/${packageName}" target="_blank" class="text-amp-blue-600 underline">npm</a> 
                    for current package details.
                </p>
            </div>
        `;
        
        card.removeAttribute('data-bundle-loader');
        card.setAttribute('data-bundle-loaded', 'error');
    }
});
</script>

